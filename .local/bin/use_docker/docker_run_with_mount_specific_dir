#!/bin/bash
#
# docker run with mount finding specific dir.
#
# 第一引数でしていたファイルまたはディレクトリが見つかる場所をルートとして、
# /src 以下にマウントし、ワーキングディレクトリを実行パスに設定する。

# 指定したファイルまたはディレクトリが見つかるまで親ディレクトリを探す
#
# 見つからない場合は、現在のディレクトリを指定するように返す
function search_parent_dir {
  current=$(pwd)
  target=$1
  max=10
  parent_dir='.'
  for ((i=0; i < $max; i++)); do
    if [ -e $current/$target ]; then
      break
    fi

    parent_dir=$(basename $current)/$parent_dir
    current=$(readlink -f $current/..)
  done
  if [ $i == $max ]; then
    current=$(pwd)
    parent_dir='.'
  fi

  echo "$current:$parent_dir"
}

target_dir=$1
command=${@:2}

old_ifs=$IFS
IFS=':'
set $(search_parent_dir $target_dir)
mount_dir=$1
work_dir=$2
IFS=$old_ifs

docker_run -v $mount_dir:/workspace:rw -w /workspace/$work_dir $command

